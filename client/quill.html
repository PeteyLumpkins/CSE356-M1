<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Yjs Quill Example</title>
    <script type="text/javascript" src="./dist/quill.bundle.js" async></script>
    <link rel=stylesheet href="//cdn.quilljs.com/1.3.6/quill.snow.css" async
    defer>
    <link rel=stylesheet href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" async
    defer>
    <link rel=stylesheet href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai-sublime.min.css" async
    defer>
    <style>
      #editor {
        min-height: 500px;
      }
    </style>
</head>
<body>
  <button type="button" onclick="disconnect()">Disconnect</button><br><br>

  <form onsubmit="getDocument(); return false;">
    Enter a document id: <input type="text" id="insertid" required="required">
  </form>
  <input type="button" onclick="getDocument()" value="Submit"><br>

  <p id="id">Document ID: Undefined</p>

  <!-- Text:
  <p id="quill"></p> -->

</body>
<script>
  let docID = undefined;
  let events = undefined;

  // create web-event connection
  function getDocument(event) {
    let insertid = document.getElementById("insertid").value;
    if (setID(insertid)){
      docID = insertid;
      doc.setDocID(docID);
      // console.log("http://localhost:3000/api/connect/" + docID);
      events = new EventSource("http://localhost:3000/api/connect/" + docID);
      events.addEventListener('sync', event => {
        console.log("[CONNECT] SYNCING");
        doc.setMutex(true);
        const eventData = JSON.parse(event.data);
        yjs.ytext.delete(0, yjs.ytext.length);  // clear yjs text
        yjs.ytext.applyDelta(eventData); // apply array of yjs.text delta to view
        doc.setMutex(false);
      });

      events.addEventListener('update', event => {
        console.log("[CONNECT] UPDATING");
        doc.setMutex(true);
        const eventData = JSON.parse(event.data);
        yjs.ytext.applyDelta(eventData); // apply ONE yjs.text delta to view
        doc.setMutex(false);
      });
    }
  }

  // stop web-event connection, clear text content
  function disconnect(event) {
      console.log("[CONNECT] DISCONNECTING");
      doc.setMutex(true);
      setID(undefined)
      events.close(); 
      yjs.ytext.delete(0, yjs.ytext.length); 
      doc.setMutex(false);
  }

  // Updates GUI
  function setID(id) {
    if (id !== undefined) {
      document.getElementById("id").innerText = "Document ID: " + id;
      return id !== docID;
    } else {
      document.getElementById("id").innerText = "Document ID: Undefined";
      return false;
    }
  }  
</script>
</html>
